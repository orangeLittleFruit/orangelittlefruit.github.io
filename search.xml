<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>usb gadget configfs 验证</title>
    <url>/2020/09/06/usb-gadget-configfs-%E9%AA%8C%E8%AF%81/</url>
    <content><![CDATA[<h3 id="内核打开对应的宏"><a href="#内核打开对应的宏" class="headerlink" title="内核打开对应的宏"></a>内核打开对应的宏</h3><p>1、必须打开<code>CONFIG_CONFIGFS_FS</code>和<code>CONFIG_USB_LIBCOMPOSITE</code>的宏，前者为用户空间提供访问配置内核驱动的configfs文件系统，后者提供usb gadget composite框架；<br>2、必须打开UDC(USB Device Controller)的配置，这个是配置硬件控制器。我这里使用<code>CONFIG_USB_CHIPIDEA</code>和<code>CONFIG_USB_CHIPIDEA_UDC</code>；<br>3、如果使用mass storage功能，需要打开<code>USB_CONFIGFS_MASS_STORAGE</code>和<code>USB_F_MASS_STORAGE</code>，对应于<code>usb_f_mass_storage.ko</code>驱动。</p>
<h3 id="配置步骤"><a href="#配置步骤" class="headerlink" title="配置步骤"></a>配置步骤</h3><ul>
<li>挂载configfs：<code>mount -t configfs none /config/</code>，在这之后，<code>/configfs/</code>目录下就会生成<code>usb_gadget/</code>目录；</li>
<li>创建gadget：<code>mkdir usb_gadget/g1</code>，创建<code>g1/</code>目录之后，该目录下会生成很多配置目录，这里的<code>g1</code>表示gadget 1，一个UDC对应一个gadget，如果你的SOC上有多个gadget，可以创建多个<code>gx</code>目录。</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> ll usb_gadget/g1/</span></span><br><span class="line">total 0</span><br><span class="line">-rw-r--r-- 1 root root 4096 1999-11-30 00:02 UDC</span><br><span class="line">-rw-r--r-- 1 root root 4096 1999-11-30 00:02 bDeviceClass</span><br><span class="line">-rw-r--r-- 1 root root 4096 1999-11-30 00:02 bDeviceProtocol</span><br><span class="line">-rw-r--r-- 1 root root 4096 1999-11-30 00:02 bDeviceSubClass</span><br><span class="line">-rw-r--r-- 1 root root 4096 1999-11-30 00:02 bMaxPacketSize0</span><br><span class="line">-rw-r--r-- 1 root root 4096 1999-11-30 00:02 bcdDevice</span><br><span class="line">-rw-r--r-- 1 root root 4096 1999-11-30 00:02 bcdUSB</span><br><span class="line">drwxr-xr-x 2 root root    0 1999-11-30 00:02 configs</span><br><span class="line">drwxr-xr-x 2 root root    0 1999-11-30 00:02 functions</span><br><span class="line">-rw-r--r-- 1 root root 4096 1999-11-30 00:02 idProduct</span><br><span class="line">-rw-r--r-- 1 root root 4096 1999-11-30 00:02 idVendor</span><br><span class="line">drwxr-xr-x 2 root root    0 1999-11-30 00:02 os_desc</span><br><span class="line">drwxr-xr-x 2 root root    0 1999-11-30 00:02 strings</span><br></pre></td></tr></table></figure>

<ul>
<li>配置PID和VID</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">echo</span> 0x18d1 &gt; usb_gadget/g1/idVendor</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">echo</span> 0x4ee2 &gt; usb_gadget/g1/idProduct</span></span><br></pre></td></tr></table></figure>

<ul>
<li>创建并配置string字目录</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> mkdir usb_gadget/g1/strings/0x409</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">echo</span> <span class="string">&quot;123456789&quot;</span> &gt; usb_gadget/g1/strings/0x409/serialnumber</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">echo</span> <span class="string">&quot;xxx&quot;</span> &gt; usb_gadget/g1/strings/0x409/manufacturer</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">echo</span> <span class="string">&quot;xxx_product&quot;</span> &gt; usb_gadget/g1/strings/0x409/product</span></span><br></pre></td></tr></table></figure>

<ul>
<li>创建configuration和字符串</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> mkdir usb_gadget/g1/configs/c.1</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> mkdir usb_gadget/g1/configs/c.1/strings/0x409</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">echo</span> <span class="string">&quot;mass_storage&quot;</span> &gt; usb_gadget/g1/configs/c.1/strings/0x409/configuration</span></span><br></pre></td></tr></table></figure>

<ul>
<li>创建functions</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> mkdir usb_gadget/g1/<span class="built_in">functions</span>/mass_storage.0</span></span><br><span class="line">[  108.582976]  [1:          mkdir: 1976] Mass Storage Function, version: 2009/09/11</span><br><span class="line">[  108.592679]  [1:          mkdir: 1976] LUN: removable file: (no medium)</span><br></pre></td></tr></table></figure>

<p>这里的<code>mass_storage</code>的名字不能随便起，需要根据insmod的function驱动<code>usb_f_mass_storage.ko</code>来决定。否则会出现如下错误：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">1|@android:/config # mkdir usb_gadget/g1/functions/msg.0</span><br><span class="line">mkdir: &#x27;usb_gadget/g1/functions/msg.0&#x27;: No such file or directory</span><br></pre></td></tr></table></figure>

<ul>
<li>将functions和configuration关联起来</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> ln -s usb_gadget/g1/<span class="built_in">functions</span>/mass_storage.0 usb_gadget/g1/configs/c.1</span></span><br></pre></td></tr></table></figure>
<p>上述配置之后，得到的结果为：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">127|@android:/config # find .</span><br><span class="line">.</span><br><span class="line">./usb_gadget</span><br><span class="line">./usb_gadget/g1</span><br><span class="line">./usb_gadget/g1/os_desc</span><br><span class="line">./usb_gadget/g1/os_desc/qw_sign</span><br><span class="line">./usb_gadget/g1/os_desc/b_vendor_code</span><br><span class="line">./usb_gadget/g1/os_desc/use</span><br><span class="line">./usb_gadget/g1/strings</span><br><span class="line">./usb_gadget/g1/strings/0x409</span><br><span class="line">./usb_gadget/g1/strings/0x409/serialnumber</span><br><span class="line">./usb_gadget/g1/strings/0x409/product</span><br><span class="line">./usb_gadget/g1/strings/0x409/manufacturer</span><br><span class="line">./usb_gadget/g1/configs</span><br><span class="line">./usb_gadget/g1/configs/c.1</span><br><span class="line">./usb_gadget/g1/configs/c.1/mass_storage.0</span><br><span class="line">./usb_gadget/g1/configs/c.1/strings</span><br><span class="line">./usb_gadget/g1/configs/c.1/strings/0x409</span><br><span class="line">./usb_gadget/g1/configs/c.1/strings/0x409/configuration</span><br><span class="line">./usb_gadget/g1/configs/c.1/bmAttributes</span><br><span class="line">./usb_gadget/g1/configs/c.1/MaxPower</span><br><span class="line">./usb_gadget/g1/functions</span><br><span class="line">./usb_gadget/g1/functions/mass_storage.0</span><br><span class="line">./usb_gadget/g1/functions/mass_storage.0/lun.0</span><br><span class="line">./usb_gadget/g1/functions/mass_storage.0/lun.0/inquiry_string</span><br><span class="line">./usb_gadget/g1/functions/mass_storage.0/lun.0/nofua</span><br><span class="line">./usb_gadget/g1/functions/mass_storage.0/lun.0/cdrom</span><br><span class="line">./usb_gadget/g1/functions/mass_storage.0/lun.0/removable</span><br><span class="line">./usb_gadget/g1/functions/mass_storage.0/lun.0/ro</span><br><span class="line">./usb_gadget/g1/functions/mass_storage.0/lun.0/file</span><br><span class="line">./usb_gadget/g1/functions/mass_storage.0/stall</span><br><span class="line">./usb_gadget/g1/UDC</span><br><span class="line">./usb_gadget/g1/bcdUSB</span><br><span class="line">./usb_gadget/g1/bcdDevice</span><br><span class="line">./usb_gadget/g1/idProduct</span><br><span class="line">./usb_gadget/g1/idVendor</span><br><span class="line">./usb_gadget/g1/bMaxPacketSize0</span><br><span class="line">./usb_gadget/g1/bDeviceProtocol</span><br><span class="line">./usb_gadget/g1/bDeviceSubClass</span><br><span class="line">./usb_gadget/g1/bDeviceClass</span><br></pre></td></tr></table></figure>

<ul>
<li>查看当前的UDC<br>可见当前的板子上有两个UDC，ci_hdrc.0和gadget-cdns3。</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">130|@android:/config # ll /sys/class/udc/</span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx 1 root root 0 1999-11-30 00:09 ci_hdrc.0 -&gt; ../../devices/platform/5b0d0000.usb/ci_hdrc.0/udc/ci_hdrc.0</span><br><span class="line">lrwxrwxrwx 1 root root 0 1999-11-30 00:09 gadget-cdns3 -&gt; ../../devices/platform/5b110000.usb3/gadget-cdns3/udc/gadget-cdns3</span><br></pre></td></tr></table></figure>
<ul>
<li>绑定到UDC，使能gadget<br>将UDC切换至device模式，这里使用OTG ID pin来实现切换。</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">echo</span> ci_hdrc.0 &gt; usb_gadget/g1/UDC</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">echo</span> 1 &gt; /sys/class/gpio/gpio358/value</span></span><br></pre></td></tr></table></figure>

<h3 id="验证结果"><a href="#验证结果" class="headerlink" title="验证结果"></a>验证结果</h3><p>将配置好的开发板与ubuntu连接，从ubuntu上的串口可以看到如下信息，表示已将开发板配置成一个mass storage的设备了。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[95705.390004] usb 1-11: USB disconnect, device number 28</span><br><span class="line">[95708.606717] usb 1-11: new high-speed USB device number 29 using xhci_hcd</span><br><span class="line">[95708.756934] usb 1-11: New USB device found, idVendor=18d1, idProduct=4ee2</span><br><span class="line">[95708.756941] usb 1-11: New USB device strings: Mfr=1, Product=2, SerialNumber=3</span><br><span class="line">[95708.756946] usb 1-11: Product: xxx_product</span><br><span class="line">[95708.756950] usb 1-11: Manufacturer: xxx</span><br><span class="line">[95708.756953] usb 1-11: SerialNumber: 123456789</span><br><span class="line">[95708.766595] usb-storage 1-11:1.0: USB Mass Storage device detected</span><br><span class="line">[95708.766798] scsi host6: usb-storage 1-11:1.0</span><br></pre></td></tr></table></figure>
<p>当然，上述的结果是ubuntu只识别到一个mass storage的设备，但是没有识别看分区表，所以没有看到相应的磁盘信息。想要看到磁盘信息，可以更进一步的设置mass_storage的<code>backen file</code>属性。</p>
<h3 id="定制分区"><a href="#定制分区" class="headerlink" title="定制分区"></a>定制分区</h3><p>在上面<code>创建functions</code>步骤之后，执行以下的命令，为mass storage创建2个分区，分区的backing file是开发板上的<code>/dev/block/mmcblk0p1</code>和<code>/dev/block/mmcblk0p2</code>，也就是开发板上的system分区和data分区。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mkdir usb_gadget/g1/functions/mass_storage.0/partition.2</span><br><span class="line">mkdir usb_gadget/g1/functions/mass_storage.0/lun.1</span><br><span class="line">echo /dev/block/mmcblk0p1 &gt; usb_gadget/g1/functions/mass_storage.0/lun.0/file</span><br><span class="line">echo /dev/block/mmcblk0p2 &gt; usb_gadget/g1/functions/mass_storage.0/lun.1/file</span><br></pre></td></tr></table></figure>
<p>所有配置完成之后，插入到ubuntu后，可以看到能识别去新的分区信息：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">130 victor@victor-HP:/mnt⟫ sudo dmesg -c</span><br><span class="line">[40873.009026] EXT4-fs (sdc): mounted filesystem with ordered data mode. Opts: (null)</span><br><span class="line">[41094.127318] usb 1-11: USB disconnect, device number 23</span><br><span class="line">[41094.128072] print_req_error: I/O error, dev sdc, sector 0</span><br><span class="line">[41094.131049] sd 6:0:0:0: [sdc] Synchronizing SCSI cache</span><br><span class="line">[41094.131118] sd 6:0:0:0: [sdc] Synchronize Cache(10) failed: Result: hostbyte=DID_NO_CONNECT driverbyte=DRIVER_OK</span><br><span class="line">[41466.480635] usb 1-11: new high-speed USB device number 24 using xhci_hcd</span><br><span class="line">[41466.630904] usb 1-11: New USB device found, idVendor=18d1, idProduct=4ee2</span><br><span class="line">[41466.630911] usb 1-11: New USB device strings: Mfr=1, Product=2, SerialNumber=3</span><br><span class="line">[41466.630915] usb 1-11: Product: xxx_product</span><br><span class="line">[41466.630919] usb 1-11: Manufacturer: xxx</span><br><span class="line">[41466.630923] usb 1-11: SerialNumber: 123456789</span><br><span class="line">[41466.640789] usb-storage 1-11:1.0: USB Mass Storage device detected</span><br><span class="line">[41466.641062] scsi host7: usb-storage 1-11:1.0</span><br><span class="line">[41467.645699] scsi 7:0:0:0: Direct-Access     Linux    File-Stor Gadget 0414 PQ: 0 ANSI: 2</span><br><span class="line">[41467.646291] scsi 7:0:0:1: Direct-Access     Linux    File-Stor Gadget 0414 PQ: 0 ANSI: 2</span><br><span class="line">[41467.646826] scsi 7:0:0:2: Direct-Access     Linux    File-Stor Gadget 0414 PQ: 0 ANSI: 2</span><br><span class="line">[41467.647387] sd 7:0:0:0: Attached scsi generic sg2 type 0</span><br><span class="line">[41467.647764] sd 7:0:0:1: Attached scsi generic sg3 type 0</span><br><span class="line">[41467.648144] sd 7:0:0:0: Power-on or device reset occurred</span><br><span class="line">[41467.648173] sd 7:0:0:2: Attached scsi generic sg4 type 0</span><br><span class="line">[41467.649026] sd 7:0:0:1: Power-on or device reset occurred</span><br><span class="line">[41467.649555] sd 7:0:0:2: Power-on or device reset occurred</span><br><span class="line">[41467.650006] sd 7:0:0:0: [sdd] 1048576 512-byte logical blocks: (537 MB/512 MiB)</span><br><span class="line">[41467.650766] sd 7:0:0:1: [sde] 524288 512-byte logical blocks: (268 MB/256 MiB)</span><br><span class="line">[41467.651726] sd 7:0:0:0: [sdd] Write Protect is off</span><br><span class="line">[41467.651731] sd 7:0:0:0: [sdd] Mode Sense: 0f 00 00 00</span><br><span class="line">[41467.651929] sd 7:0:0:1: [sde] Write Protect is off</span><br><span class="line">[41467.651933] sd 7:0:0:1: [sde] Mode Sense: 0f 00 00 00</span><br><span class="line">[41467.652327] sd 7:0:0:2: [sdf] Attached SCSI removable disk</span><br><span class="line">[41467.652581] sd 7:0:0:0: [sdd] Write cache: enabled, read cache: enabled, doesn&#x27;t support DPO or FUA</span><br><span class="line">[41467.652837] sd 7:0:0:1: [sde] Write cache: enabled, read cache: enabled, doesn&#x27;t support DPO or FUA</span><br><span class="line">[41467.673305] sd 7:0:0:1: [sde] Attached SCSI removable disk</span><br><span class="line">[41467.674915] sd 7:0:0:0: [sdd] Attached SCSI removable disk</span><br></pre></td></tr></table></figure>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p>上述的配置过程太繁琐了，在Android上，基于configfs有专门的<code>init.rc</code>在启动过程中去配置对应的<code>configuration</code>和<code>function</code>，比如说<code>init.usb.rc</code>，里面包含了一系列gadget的配置方法。在后面的文章中，将详细讲述每条命令背后的实现原理。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">on boot</span><br><span class="line">    write /config/usb_gadget/g1/strings/0x409/serialnumber $&#123;ro.serialno&#125;</span><br><span class="line">    write /config/usb_gadget/g1/strings/0x409/manufacturer $&#123;ro.product.manufacturer&#125;</span><br><span class="line">    write /config/usb_gadget/g1/strings/0x409/product $&#123;ro.product.model&#125;</span><br><span class="line"></span><br><span class="line">    setprop sys.usb.configfs 1</span><br><span class="line"></span><br><span class="line">    # OS DESCRIPTORS</span><br><span class="line">    #===============</span><br><span class="line">    # OS STRING</span><br><span class="line">    #----------</span><br><span class="line">    write /config/usb_gadget/g1/os_desc/b_vendor_code 1</span><br><span class="line">    write /config/usb_gadget/g1/os_desc/qw_sign &quot;MSFT100&quot;</span><br><span class="line">    # use os desc or not is up to each usb functions respectively</span><br><span class="line">    # write /config/usb_gadget/g1/os_desc/use 1</span><br><span class="line"></span><br><span class="line">    # MAKE b.1 THE ONE ASSOCIATED WITH OS DESCRIPTORS</span><br><span class="line">    #------------------------------------------------</span><br><span class="line">    symlink /config/usb_gadget/g1/configs/b.1 /config/usb_gadget/g1/os_desc/b1</span><br><span class="line"></span><br><span class="line">    # ci_hdrc.0 is the fixed UDC name</span><br><span class="line">    setprop sys.usb.controller ci_hdrc.0</span><br><span class="line"></span><br><span class="line">on fs</span><br><span class="line">    mkdir /dev/usb-ffs 0770 shell shell</span><br><span class="line">    mkdir /dev/usb-ffs/adb 0770 shell shell</span><br><span class="line">    # mount the configfs on /config</span><br><span class="line">    mount configfs none /config mode=0755</span><br><span class="line">    mkdir /config/usb_gadget/g1</span><br><span class="line">    mkdir /config/usb_gadget/g1/configs/b.1</span><br><span class="line">    # mkdir for functions needed</span><br><span class="line">    # this will call each gadget&#x27;s alloc_inst()</span><br><span class="line">    mkdir /config/usb_gadget/g1/functions/ffs.adb</span><br><span class="line">    mkdir /config/usb_gadget/g1/functions/mtp.gs0</span><br><span class="line">    mkdir /config/usb_gadget/g1/functions/ptp.gs1</span><br><span class="line">    mkdir /config/usb_gadget/g1/functions/accessory.gs2</span><br><span class="line">    mkdir /config/usb_gadget/g1/functions/audio_source.gs3</span><br><span class="line">    mkdir /config/usb_gadget/g1/functions/rndis.gs4</span><br><span class="line">    mkdir /config/usb_gadget/g1/functions/midi.gs5</span><br><span class="line">    mkdir /config/usb_gadget/g1/strings/0x409</span><br><span class="line">    mkdir /config/usb_gadget/g1/configs/b.1/strings/0x409</span><br><span class="line">    # The mount of functionfs for adb must be put AFTER the mkdir for functions in configfs</span><br><span class="line"></span><br><span class="line">on property:sys.usb.config=none &amp;&amp; property:sys.usb.configfs=1</span><br><span class="line">    write /config/usb_gadget/g1/os_desc/use 0</span><br><span class="line"></span><br><span class="line">on property:sys.usb.ffs.ready=1 &amp;&amp; property:sys.usb.config=adb &amp;&amp; property:sys.usb.configfs=1</span><br><span class="line">    write /config/usb_gadget/g1/idProduct 0x4ee7</span><br><span class="line">    write /config/usb_gadget/g1/idVendor 0x18d1</span><br><span class="line"></span><br><span class="line">on property:sys.usb.config=mtp &amp;&amp; property:sys.usb.configfs=1</span><br><span class="line">    write /config/usb_gadget/g1/functions/mtp.gs0/os_desc/interface.MTP/compatible_id &quot;MTP&quot;</span><br><span class="line">    write /config/usb_gadget/g1/os_desc/use 1</span><br><span class="line">    write /config/usb_gadget/g1/idProduct 0x4ee1</span><br><span class="line">    write /config/usb_gadget/g1/idVendor 0x18d1</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Linux驱动</category>
        <category>USB</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Hello World</title>
    <url>/2020/09/06/hello-world/</url>
    <content><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>
]]></content>
  </entry>
</search>
